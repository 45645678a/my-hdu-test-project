// ==UserScript==
// @name         æ™ºæ…§è¯¾å ‚ä¸‹è½½å™¨ (V10.4)
// @namespace    http://tampermonkey.net/
// @version      10.4
// @description  ä¿®å¤ä¸‹è½½é—®é¢˜ + æ–°æ ‡ç­¾é¡µè·³è½¬
// @author       You
// @match        *://*/*
// @grant        GM_download
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @connect      *
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const CONFIG = {
        jumpDelay: 5000,      // ä¸‹è½½åç­‰5ç§’å†è·³è½¬
        stableTime: 800,
        detectInterval: 500,
        openInNewTab: true    // ã€æ–°å¢ã€‘æ–°æ ‡ç­¾é¡µæ‰“å¼€
    };

    const STATE = {
        lastUrl: GM_getValue('lastDownloadedUrl', ''),
        isPaused: false,
        isBusy: false,
        pendingTimer: null,
        pendingUrl: '',
        downloadCount: GM_getValue('downloadCount', 0)
    };

    // ================= UI =================
    const panel = document.createElement('div');
    panel.id = 'dl_panel';
    const savedPos = GM_getValue('panelPosition', { left: window.innerWidth - 360, top: 80 });
    panel.style.cssText = `
        position: fixed; left: ${savedPos.left}px; top: ${savedPos.top}px; z-index: 2147483647;
        background: rgba(10, 10, 10, 0.95); color: #0f0; width: 340px;
        border: 2px solid #00ff00; border-radius: 10px; font-family: 'Consolas', monospace;
        box-shadow: 0 0 20px rgba(0,255,0,0.3); font-size: 12px; user-select: none;
    `;
    panel.innerHTML = `
        <div id="panel_header" style="padding:12px; background:linear-gradient(135deg,#1a1a2e,#16213e); border-bottom:1px solid #0f0; cursor:move; border-radius:8px 8px 0 0; font-weight:bold; font-size:14px;">
            ğŸ¬ è¯¾ç¨‹ä¸‹è½½å™¨ V10.4 <span id="ui_count" style="float:right; color:#0cc;">#0</span>
        </div>
        <div style="padding:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="color:#888;">è§†é¢‘ç±»å‹:</span>
                <span id="ui_src_type" style="color:#0f0;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="color:#888; margin-bottom:4px;">å½“å‰åœ°å€:</div>
            <div id="ui_current_src" style="color:#fff; background:#222; padding:6px; margin-bottom:10px; border-radius:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:10px;">ç­‰å¾…...</div>

            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="color:#888;">çŠ¶æ€:</span>
                <span id="ui_status" style="color:#0cc; font-weight:bold;">â³ å°±ç»ª</span>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
                <button id="btn_toggle" class="dl-btn" style="background:#28a745;">â¸ æš‚åœ</button>
                <button id="btn_skip" class="dl-btn" style="background:#ffc107; color:#000;">â­ ä¸‹ä¸€èŠ‚</button>
                <button id="btn_force" class="dl-btn" style="background:#d63384;">â¬‡ï¸ ç«‹å³ä¸‹è½½</button>
                <button id="btn_open" class="dl-btn" style="background:#0d6efd;">ğŸ”— æ‰“å¼€è§†é¢‘</button>
            </div>
            <button id="btn_clear" class="dl-btn" style="width:100%; background:#6c757d;">ğŸ—‘ï¸ æ¸…é™¤è®°å½•ï¼ˆé‡æ–°å¼€å§‹ï¼‰</button>

            <details style="margin-top:10px;" open>
                <summary style="color:#888; cursor:pointer;">ğŸ“‹ è°ƒè¯•æ—¥å¿—</summary>
                <div id="ui_log" style="color:#aaa; background:#111; padding:6px; margin-top:6px; height:100px; overflow-y:auto; font-size:11px; border-radius:4px; line-height:1.4;"></div>
            </details>
        </div>
        <style>
            .dl-btn { padding:10px 8px; cursor:pointer; color:#fff; border:none; border-radius:5px; font-size:12px; font-weight:bold; transition: all 0.2s; }
            .dl-btn:hover { filter: brightness(1.2); transform: scale(1.02); }
            .dl-btn:active { transform: scale(0.98); }
        </style>
    `;
    document.body.appendChild(panel);

    const ui = {
        srcType: document.getElementById('ui_src_type'),
        src: document.getElementById('ui_current_src'),
        status: document.getElementById('ui_status'),
        log: document.getElementById('ui_log'),
        count: document.getElementById('ui_count'),
        btnToggle: document.getElementById('btn_toggle'),
        btnSkip: document.getElementById('btn_skip'),
        btnForce: document.getElementById('btn_force'),
        btnOpen: document.getElementById('btn_open'),
        btnClear: document.getElementById('btn_clear')
    };

    ui.count.innerText = `#${STATE.downloadCount}`;

    function log(msg, color = '#aaa') {
        const time = new Date().toLocaleTimeString();
        ui.log.innerHTML = `<div style="color:${color}">[${time}] ${msg}</div>` + ui.log.innerHTML;
        console.log(`[DL] ${msg}`);
    }

    function updateStatus(text, color = '#fff') {
        ui.status.innerText = text;
        ui.status.style.color = color;
    }

    // ================= æ‹–æ‹½ =================
    const header = document.getElementById('panel_header');
    let isDragging = false, offsetX, offsetY;

    header.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'SPAN') return;
        isDragging = true;
        offsetX = e.clientX - panel.getBoundingClientRect().left;
        offsetY = e.clientY - panel.getBoundingClientRect().top;
        panel.style.opacity = '0.85';
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        panel.style.left = Math.max(0, e.clientX - offsetX) + 'px';
        panel.style.top = Math.max(0, e.clientY - offsetY) + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            panel.style.opacity = '1';
            GM_setValue('panelPosition', {
                left: parseInt(panel.style.left),
                top: parseInt(panel.style.top)
            });
        }
    });

    // ================= æŒ‰é’®äº‹ä»¶ =================
    ui.btnToggle.onclick = () => {
        STATE.isPaused = !STATE.isPaused;
        ui.btnToggle.innerText = STATE.isPaused ? "â–¶ æ¢å¤" : "â¸ æš‚åœ";
        ui.btnToggle.style.background = STATE.isPaused ? "#6c757d" : "#28a745";
        updateStatus(STATE.isPaused ? "â›” å·²æš‚åœ" : "âœ… è¿è¡Œä¸­", STATE.isPaused ? "#f55" : "#0f0");
        log(STATE.isPaused ? "å·²æš‚åœ" : "å·²æ¢å¤", STATE.isPaused ? "#f55" : "#0f0");
    };

    ui.btnSkip.onclick = () => {
        STATE.isBusy = false;
        STATE.pendingUrl = '';
        log("æ‰‹åŠ¨è·³è½¬ä¸‹ä¸€èŠ‚", "#ffc107");
        jumpToNext();
    };

    ui.btnForce.onclick = () => {
        const video = findVideo();
        const src = getVideoSrc(video);
        if (src) {
            log("æ‰‹åŠ¨å¼ºåˆ¶ä¸‹è½½", "#d63384");
            startDownload(src, true);
        } else {
            updateStatus("âŒ æ— è§†é¢‘", "#f55");
            log("æ‰¾ä¸åˆ°è§†é¢‘æº", "#f55");
        }
    };

    ui.btnOpen.onclick = () => {
        const video = findVideo();
        const src = getVideoSrc(video);
        if (src && !src.startsWith('blob:')) {
            window.open(src, '_blank');
            log("å·²åœ¨æ–°çª—å£æ‰“å¼€è§†é¢‘", "#0d6efd");
        } else {
            updateStatus("âŒ æ— æ³•æ‰“å¼€", "#f55");
        }
    };

    ui.btnClear.onclick = () => {
        STATE.lastUrl = '';
        STATE.pendingUrl = '';
        STATE.downloadCount = 0;
        GM_setValue('lastDownloadedUrl', '');
        GM_setValue('downloadCount', 0);
        ui.count.innerText = '#0';
        updateStatus("ğŸ—‘ï¸ å·²æ¸…é™¤", "#0f0");
        log("è®°å½•å·²æ¸…é™¤", "#0f0");
    };

    // ================= æŸ¥æ‰¾è§†é¢‘ =================
    function findVideo() {
        // ä¸»æ–‡æ¡£
        let video = document.querySelector('video');
        if (video) return video;

        // iframe
        try {
            const iframes = document.querySelectorAll('iframe');
            for (const iframe of iframes) {
                const v = iframe.contentDocument?.querySelector('video');
                if (v) return v;
            }
        } catch (e) {}

        return null;
    }

    function getVideoSrc(video) {
        if (!video) return '';
        if (video.src && video.src.startsWith('http')) return video.src;
        const source = video.querySelector('source');
        if (source?.src) return source.src;
        return video.currentSrc || '';
    }

    // ================= ç”Ÿæˆæ–‡ä»¶å =================
    function generateFileName() {
        let name = '';

        const activeItem = document.querySelector('.body-item.active, .video-item.active, .list-item.active');
        if (activeItem) {
            name = activeItem.innerText.split('\n')[0].trim();
        }

        if (!name) {
            name = document.title.replace(/æ™ºæ…§è¯¾å ‚|åœ¨çº¿|æ’­æ”¾|è§†é¢‘|-|_/g, ' ').trim();
        }

        if (!name) name = 'video_' + Date.now();

        name = name.replace(/[\\/:*?"<>|]/g, '').replace(/\s+/g, '_').substring(0, 60);
        if (!name.toLowerCase().endsWith('.mp4')) name += '.mp4';

        return name;
    }

    // ================= ã€æ ¸å¿ƒã€‘ä¸‹è½½å‡½æ•° =================
    function startDownload(url, force = false) {
        if (!url) {
            log("URLä¸ºç©ºï¼Œè·³è¿‡", "#f55");
            return;
        }

        if (url.startsWith('blob:')) {
            log("Blobæ ¼å¼ä¸æ”¯æŒ", "#fa0");
            updateStatus("âš ï¸ Blobä¸æ”¯æŒ", "#fa0");
            return;
        }

        if (!force && url === STATE.lastUrl) {
            log("é‡å¤åœ°å€ï¼Œè·³è¿‡", "#888");
            updateStatus("â­ å·²ä¸‹è½½è¿‡", "#fa0");
            return;
        }

        STATE.isBusy = true;
        STATE.lastUrl = url;
        STATE.pendingUrl = '';
        GM_setValue('lastDownloadedUrl', url);

        const fileName = generateFileName();
        log(`å¼€å§‹ä¸‹è½½: ${fileName}`, '#d63384');
        updateStatus(`â¬‡ï¸ ä¸‹è½½ä¸­...`, "#d63384");

        // ã€å…³é”®ã€‘ä½¿ç”¨ GM_downloadï¼Œè¿™ä¸ªæ›´å¯é 
        try {
            GM_download({
                url: url,
                name: fileName,
                saveAs: false,
                onerror: (err) => {
                    log(`GM_download é”™è¯¯: ${err.error}`, '#f55');
                    // å¤‡ç”¨æ–¹æ¡ˆ
                    fallbackDownload(url, fileName);
                },
                onload: () => {
                    log(`ä¸‹è½½å·²å®Œæˆ: ${fileName}`, '#0f0');
                },
                ontimeout: () => {
                    log('ä¸‹è½½è¶…æ—¶ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ', '#fa0');
                    fallbackDownload(url, fileName);
                }
            });

            // æ›´æ–°è®¡æ•°
            STATE.downloadCount++;
            GM_setValue('downloadCount', STATE.downloadCount);
            ui.count.innerText = `#${STATE.downloadCount}`;

            log("GM_download å·²è§¦å‘", "#0f0");

        } catch (e) {
            log(`ä¸‹è½½å¼‚å¸¸: ${e.message}`, '#f55');
            fallbackDownload(url, fileName);
        }

        // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€èŠ‚
        if (!STATE.isPaused) {
            log(`${CONFIG.jumpDelay/1000}ç§’åè·³è½¬ä¸‹ä¸€èŠ‚...`, '#0cc');
            setTimeout(() => {
                updateStatus("â³ è·³è½¬ä¸­...", "#0cc");
                jumpToNext();
            }, CONFIG.jumpDelay);
        } else {
            STATE.isBusy = false;
        }
    }

    // å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ
    function fallbackDownload(url, fileName) {
        log("ä½¿ç”¨å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ", "#fa0");

        // æ–¹æ¡ˆ1: åˆ›å»ºéšè— iframe ä¸‹è½½
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);

        // æ–¹æ¡ˆ2: åŒæ—¶å°è¯• a æ ‡ç­¾
        setTimeout(() => {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.target = '_blank';
            a.rel = 'noopener';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => a.remove(), 500);
        }, 500);

        setTimeout(() => iframe.remove(), 3000);
    }

    // ================= ã€ä¿®æ”¹ã€‘è·³è½¬ä¸‹ä¸€èŠ‚ - æ–°æ ‡ç­¾é¡µ =================
    function jumpToNext() {
        const activeItem = document.querySelector('.body-item.active');

        if (!activeItem) {
            log("æ‰¾ä¸åˆ°å½“å‰è¯¾ç¨‹é¡¹", "#f55");
            updateStatus("âŒ æ‰¾ä¸åˆ°å½“å‰é¡¹", "#f55");
            STATE.isBusy = false;
            return;
        }

        // æ‰¾ä¸‹ä¸€ä¸ª body-item
        let nextItem = activeItem.nextElementSibling;
        while (nextItem && !nextItem.classList.contains('body-item')) {
            nextItem = nextItem.nextElementSibling;
        }

        if (nextItem) {
            log("æ‰¾åˆ°ä¸‹ä¸€èŠ‚ï¼Œå‡†å¤‡è·³è½¬", "#0cc");

            if (CONFIG.openInNewTab) {
                // ã€æ–°æ ‡ç­¾é¡µæ–¹å¼ã€‘
                // å°è¯•è·å–ä¸‹ä¸€èŠ‚çš„é“¾æ¥
                const link = nextItem.querySelector('a');
                if (link && link.href) {
                    log(`æ–°æ ‡ç­¾é¡µæ‰“å¼€: ${link.href.slice(-30)}`, "#0cc");
                    GM_openInTab(link.href, { active: true });
                    updateStatus("âœ… å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€", "#0f0");
                } else {
                    // æ²¡æœ‰é“¾æ¥ï¼Œå°è¯•ç‚¹å‡»åè·å–URLå˜åŒ–
                    log("æ— ç›´æ¥é“¾æ¥ï¼Œå°è¯•ç‚¹å‡»æ–¹å¼", "#fa0");
                    clickAndNavigate(nextItem);
                }
            } else {
                // å½“å‰é¡µé¢è·³è½¬
                clickAndNavigate(nextItem);
            }
        } else {
            log("æ²¡æœ‰æ›´å¤šè¯¾ç¨‹äº†", "#f0f");
            updateStatus("ğŸ‰ å…¨éƒ¨å®Œæˆ!", "#f0f");
            STATE.isBusy = false;
        }
    }

    function clickAndNavigate(item) {
        item.scrollIntoView({ behavior: "smooth", block: "center" });

        setTimeout(() => {
            // ç‚¹å‡»å…ƒç´ 
            item.click();

            // å°è¯•ç‚¹å‡»å†…éƒ¨å¯ç‚¹å‡»å…ƒç´ 
            const inner = item.querySelector('.left-box, a, [class*="title"]');
            if (inner) {
                inner.click();
            }

            updateStatus("âœ… å·²è·³è½¬", "#0f0");
            log("ç‚¹å‡»è·³è½¬æˆåŠŸ", "#0f0");

            setTimeout(() => {
                STATE.isBusy = false;
            }, 2000);
        }, 300);
    }

    // ================= ä¸»æ£€æµ‹å¾ªç¯ =================
    setInterval(() => {
        const video = findVideo();
        const currentSrc = getVideoSrc(video);

        if (currentSrc && currentSrc.startsWith('http')) {
            // UI æ›´æ–°
            ui.srcType.innerText = currentSrc.includes('webvpn') ? "âœ… WebVPN" : "âœ… HTTP";
            ui.srcType.style.color = "#0f0";
            ui.src.innerText = "..." + currentSrc.slice(-50);
            ui.src.title = currentSrc;

            if (STATE.isPaused || STATE.isBusy) return;

            // æ£€æµ‹æ–°è§†é¢‘
            if (currentSrc !== STATE.lastUrl && currentSrc !== STATE.pendingUrl) {
                STATE.pendingUrl = currentSrc;
                updateStatus("ğŸ‘€ æ£€æµ‹åˆ°æ–°è§†é¢‘", "#ff0");
                log("å‘ç°æ–°è§†é¢‘æº", "#ff0");

                clearTimeout(STATE.pendingTimer);
                STATE.pendingTimer = setTimeout(() => {
                    const nowSrc = getVideoSrc(findVideo());
                    if (nowSrc === currentSrc && currentSrc !== STATE.lastUrl) {
                        log("è§†é¢‘æºç¨³å®šï¼Œå¼€å§‹ä¸‹è½½", "#0f0");
                        startDownload(currentSrc);
                    }
                }, CONFIG.stableTime);
            }
        } else if (currentSrc?.startsWith('blob:')) {
            ui.srcType.innerText = "âš ï¸ Blob";
            ui.srcType.style.color = "#fa0";
            ui.src.innerText = "Blobæ ¼å¼ (ä¸æ”¯æŒ)";
        } else {
            ui.srcType.innerText = "â“ æ— è§†é¢‘";
            ui.srcType.style.color = "#888";
            ui.src.innerText = "ç­‰å¾…è§†é¢‘åŠ è½½...";
        }
    }, CONFIG.detectInterval);

    // å¯åŠ¨
    log("=== è„šæœ¬å¯åŠ¨ V10.4 ===", "#0f0");
    log(`å·²ä¸‹è½½ ${STATE.downloadCount} ä¸ªè§†é¢‘`, "#0cc");
    if (STATE.lastUrl) {
        log("ä¸Šæ¬¡: ..." + STATE.lastUrl.slice(-35), "#888");
    }
    updateStatus("âœ… å°±ç»ªï¼Œç­‰å¾…è§†é¢‘", "#0f0");

})();